<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LoPAS PKO Demo (UI → Cloudflare API)</title>
<style>
  :root{--bg:#0b1020;--card:#121831;--muted:#9fb0d9;--text:#e9f0ff;--ok:#2fd47a;--warn:#ffb020;--bad:#ff5d6c;--br:rgba(255,255,255,.12)}
  *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,"Noto Sans JP",sans-serif}
  body{margin:0;background:radial-gradient(1200px 600px at 70% -200px,#1a254b 0%,#0b1020 55%,#0a0f1f 100%);color:var(--text)}
  header{padding:24px 16px 6px;max-width:1100px;margin:0 auto}
  h1{margin:0 0 6px;font-size:clamp(18px,3vw,26px)}
  .sub{color:var(--muted);font-size:13px}
  main{max-width:1100px;margin:0 auto;padding:12px 16px 60px;display:grid;gap:14px;grid-template-columns:1.1fr .9fr}
  @media (max-width:980px){main{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.015));border:1px solid var(--br);border-radius:16px;padding:14px}
  .grid{display:grid;grid-template-columns:160px 1fr 60px;gap:10px;align-items:center}
  .row{display:grid;grid-template-columns:150px 1fr 80px;gap:10px;align-items:center;margin:8px 0}
  input[type=range],input[type=number],textarea{width:100%}
  textarea{min-height:120px;background:#101735;color:#e9f0ff;border:1px solid var(--br);border-radius:10px;padding:8px}
  input,button{background:#101735;color:#e9f0ff;border:1px solid var(--br);border-radius:10px;padding:8px}
  .btn{padding:10px 14px;border-radius:12px;background:#1f2b54;cursor:pointer}
  .btn.secondary{background:#0f1635}
  .badge{display:inline-flex;align-items:center;border-radius:999px;padding:4px 10px;font-weight:700;font-size:12px;margin:2px;border:1px solid var(--br)}
  .g{background:rgba(47,212,122,.15);color:#bdf3d6;border-color:rgba(47,212,122,.35)}
  .a{background:rgba(255,176,32,.15);color:#ffe3b3;border-color:rgba(255,176,32,.35)}
  .r{background:rgba(255,93,108,.15);color:#ffd0d4;border-color:rgba(255,93,108,.35)}
  .meter{height:10px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden}
  .fill{height:100%;background:linear-gradient(90deg,#36d39e,#2a9df4);width:0%}
  .mono{font-family:ui-monospace,Consolas,monospace;font-size:12px;white-space:pre-wrap;word-break:break-all;color:#cae0ff}
  .muted{color:var(--muted)}
  .err{display:none;border:1px solid #f2b8b5;background:#ffecec;color:#851d19;border-radius:8px;padding:8px 10px;margin:8px 0}
</style>
</head>
<body>
<header>
  <h1>LoPAS PKO Demo (UI → API JSON)</h1>
  <div class="sub">
    API: <span id="api_url"></span>　例：<code>?live=1&api=https://icy-wave-e70d.hanabokur0.workers.dev</code>
  </div>
</header>

<main>
  <!-- 左：入力 -->
  <section class="card">
    <h3>Inputs (features)</h3>
    <div class="grid">
      <span>DoQ: questionCount</span><input id="doq_q" type="range" min="0" max="12" value="10"/><span id="doq_q_v">10</span>
      <span>DoQ: struct</span><input id="doq_s" type="range" min="0" max="100" value="70"/><span id="doq_s_v">70</span>
      <span>DoQ: diversity</span><input id="doq_d" type="range" min="0" max="100" value="60"/><span id="doq_d_v">60</span>
      <span>DoQ: integration</span><input id="doq_i" type="range" min="0" max="100" value="80"/><span id="doq_i_v">80</span>
      <span>TRS: fatigue</span><input id="trs_f" type="range" min="0" max="100" value="30"/><span id="trs_f_v">30</span>
      <span>TRS: recovery</span><input id="trs_r" type="range" min="0" max="100" value="70"/><span id="trs_r_v">70</span>
      <span>TRS: reward</span><input id="trs_w" type="range" min="0" max="100" value="60"/><span id="trs_w_v">60</span>
      <span>TRS: meaning</span><input id="trs_m" type="range" min="0" max="100" value="80"/><span id="trs_m_v">80</span>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="btn_features">解析（features→scores）</button>
      <button class="btn secondary" id="btn_scores">解析（scores直渡し）</button>
    </div>

    <div class="card" style="margin-top:12px">
      <h4>Scores (direct)</h4>
      <div class="grid">
        <span>DoQ</span><input id="s_doq" type="number" min="0" max="100" value="60"/><span></span>
        <span>CCI</span><input id="s_cci" type="number" min="0" max="100" value="61"/><span></span>
        <span>RDI</span><input id="s_rdi" type="number" min="0" max="100" value="62"/><span></span>
        <span>HRI</span><input id="s_hri" type="number" min="0" max="100" value="55"/><span></span>
        <span>TRS</span><input id="s_trs" type="number" min="0" max="100" value="59"/><span></span>
        <span>RVI</span><input id="s_rvi" type="number" min="0" max="100" value="50"/><span></span>
        <span>AHI</span><input id="s_ahi" type="number" min="0" max="100" value="54"/><span></span>
      </div>
      <button class="btn secondary" id="btn_scores2">送信（scores直渡し）</button>
    </div>

    <div class="card" style="margin-top:12px">
      <h4>Documents (heuristic)</h4>
      <textarea id="doc_text" placeholder="ここに文章を貼り付け → heuristic 推定"></textarea>
      <button class="btn secondary" id="btn_docs">解析（documents→heuristic）</button>
    </div>

    <div id="err" class="err"></div>
  </section>

  <!-- 右：出力 -->
  <section class="card">
    <h3>Outputs</h3>
    <div class="grid">
      <span>DoQ</span><span id="out_doq">—</span><span></span>
      <span>CCI</span><span id="out_cci">—</span><span></span>
      <span>RDI</span><span id="out_rdi">—</span><span></span>
      <span>HRI</span><span id="out_hri">—</span><span></span>
      <span>TRS</span><span id="out_trs">—</span><span></span>
      <span>RVI</span><span id="out_rvi">—</span><span></span>
      <span>AHI</span><span id="out_ahi">—</span><span></span>
      <span>SCI</span>
      <div>
        <div class="meter"><div id="sciFill" class="fill"></div></div>
      </div>
      <span id="out_grade" class="badge g">—</span>
    </div>
    <div id="judgment_wrap" style="margin-top:10px;display:none">
      <div class="badge g" id="phaseBadge">STABLE</div>
      <div class="badge g" id="playbookBadge">NONE</div>
      <div class="mono" id="advice" style="margin-top:6px"></div>
    </div>
    <div class="mono" id="raw" style="margin-top:12px"></div>
  </section>
</main>

<script>
(function(){
  // === API base ===
  const qs = (k)=> new URLSearchParams(location.search).get(k);
  const API = (qs('api')||'https://icy-wave-e70d.hanabokur0.workers.dev').replace(/\/+$/,'');
  document.getElementById('api_url').textContent = API;

  // === helpers ===
  function showErr(msg){ const e=document.getElementById('err'); e.textContent=msg; e.style.display='block'; setTimeout(()=>e.style.display='none',5000); }
  async function postJSON(path,payload){
    try{
      const res = await fetch(API+path,{ method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(payload), mode:'cors' });
      const txt = await res.text(); // for debug safety
      let data; try{ data = JSON.parse(txt); } catch{ throw new Error('Bad JSON: '+txt.slice(0,200)); }
      if(!res.ok) throw new Error('HTTP '+res.status);
      document.getElementById('raw').textContent = JSON.stringify(data, null, 2); // debug view
      return data;
    }catch(e){ showErr(e.message||String(e)); throw e; }
  }
  const put = (id,val)=>{ const el=document.getElementById(id); if(!el) return; el.textContent = (val==null?'—':String(val)); };

  // slider value mirror
  for(const id of ['doq_q','doq_s','doq_d','doq_i','trs_f','trs_r','trs_w','trs_m']){
    const el=document.getElementById(id), v=document.getElementById(id+'_v'); if(el&&v){ el.addEventListener('input',()=>v.textContent=el.value); v.textContent=el.value; }
  }

  // === payload builders ===
  function buildFeatures(){
    const g=id=>Number(document.getElementById(id)?.value||0);
    return { DoQ:{questionCount:g('doq_q'),struct:g('doq_s'),diversity:g('doq_d'),integration:g('doq_i')},
             TRS:{fatigue:g('trs_f'),recovery:g('trs_r'),reward:g('trs_w'),meaning:g('trs_m')} };
  }
  function buildScores(){
    const g=id=>Number(document.getElementById(id)?.value||0);
    return { DoQ:g('s_doq'), CCI:g('s_cci'), RDI:g('s_rdi'), HRI:g('s_hri'), TRS:g('s_trs'), RVI:g('s_rvi'), AHI:g('s_ahi') };
  }

  // === render ===
  function band(v){ return v>=70?'r':v>=55?'a':'g'; }
  function render(out){
    put('out_doq',out.DoQ); put('out_cci',out.CCI); put('out_rdi',out.RDI);
    put('out_hri',out.HRI); put('out_trs',out.TRS); put('out_rvi',out.RVI);
    put('out_ahi',out.AHI); put('out_sci',out.SCI);
    const fill=document.getElementById('sciFill'); if(fill&&out.SCI!=null) fill.style.width = Math.max(0,Math.min(100,Number(out.SCI)))+'%';
    const grade=document.getElementById('out_grade'); if(grade){ grade.textContent = out.SCI_grade||'—'; grade.className='badge '+(out.SCI_grade==='RED'?'r':out.SCI_grade==='YELLOW'?'a':'g'); }
    const wrap=document.getElementById('judgment_wrap'), phase=document.getElementById('phaseBadge'), play=document.getElementById('playbookBadge'), adv=document.getElementById('advice');
    if(out.judgment){ wrap.style.display='block'; adv.textContent = (out.judgment.bullets||[]).map(x=>'• '+x).join('\n');
      const ph = out.SCI>=70?'CRITICAL':out.SCI>=55?'WATCH':'STABLE';
      const pb = out.SCI>=70?'HARD':out.SCI>=55?'SOFT':'NONE';
      phase.textContent=ph; phase.className='badge '+(ph==='CRITICAL'?'r':ph==='WATCH'?'a':'g');
      play.textContent=pb; play.className='badge '+(pb==='HARD'?'r':pb==='SOFT'?'a':'g');
    } else { wrap.style.display='none'; }
  }

  // === actions ===
  async function runFeatures(){ const out = await postJSON('/api/score', { inputs: buildFeatures() }); render(out.outputs||{}); }
  async function runScores(){ const out = await postJSON('/api/score', { scores: buildScores() }); render(out.outputs||{}); }
  async function runDocs(){
    const txt = (document.getElementById('doc_text').value||'').trim(); if(!txt) return;
    const out = await postJSON('/api/score', { documents:[{text:txt}] }); render(out.outputs||{});
  }

  document.getElementById('btn_features')?.addEventListener('click', runFeatures);
  document.getElementById('btn_scores')?.addEventListener('click', runScores);
  document.getElementById('btn_scores2')?.addEventListener('click', runScores);
  document.getElementById('btn_docs')?.addEventListener('click', runDocs);
})();
</script>
</body>
</html>
