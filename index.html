<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LoPAS Demo (JSON bridge)</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:900px;margin:24px auto;padding:0 12px;}
    h1{font-size:20px;margin:0 0 8px;}
    .row{display:flex;gap:16px;flex-wrap:wrap;margin:12px 0;}
    .card{border:1px solid #ddd;border-radius:8px;padding:12px;flex:1;min-width:260px}
    label{display:flex;justify-content:space-between;gap:8px;margin:6px 0;}
    input[type="range"]{width:62%}
    .btn{padding:10px 14px;border:1px solid #444;border-radius:8px;background:#111;color:#fff;cursor:pointer}
    .out{font-weight:bold}
    .muted{color:#777}
    .grid{display:grid;grid-template-columns:160px 1fr 120px;gap:6px;align-items:center}
    .mono{font-family:ui-monospace,Consolas,monospace}
  </style>
</head>
<body>
  <h1>LoPAS Demo (UI → API JSON)</h1>
  <p class="muted mono">
    API = <span id="api_url"></span> |
    Open with: <code>?live=1&api=https://icy-wave-e70d.hanabokur0.workers.dev</code>
  </p>

  <div class="row">
    <div class="card">
      <h3>Inputs (features)</h3>
      <div class="grid">
        <span>DoQ: questionCount</span>
        <input id="doq_q" type="range" min="0" max="12" value="10" />
        <span class="mono" id="doq_q_v">10</span>

        <span>DoQ: struct</span>
        <input id="doq_s" type="range" min="0" max="100" value="70" />
        <span class="mono" id="doq_s_v">70</span>

        <span>DoQ: diversity</span>
        <input id="doq_d" type="range" min="0" max="100" value="60" />
        <span class="mono" id="doq_d_v">60</span>

        <span>DoQ: integration</span>
        <input id="doq_i" type="range" min="0" max="100" value="80" />
        <span class="mono" id="doq_i_v">80</span>

        <span>TRS: fatigue</span>
        <input id="trs_f" type="range" min="0" max="100" value="30" />
        <span class="mono" id="trs_f_v">30</span>

        <span>TRS: recovery</span>
        <input id="trs_r" type="range" min="0" max="100" value="70" />
        <span class="mono" id="trs_r_v">70</span>

        <span>TRS: reward</span>
        <input id="trs_w" type="range" min="0" max="100" value="60" />
        <span class="mono" id="trs_w_v">60</span>

        <span>TRS: meaning</span>
        <input id="trs_m" type="range" min="0" max="100" value="80" />
        <span class="mono" id="trs_m_v">80</span>
      </div>

      <div style="margin-top:10px; display:flex; gap:8px;">
        <button class="btn" id="btn_features">解析（features→scores）</button>
        <button class="btn" id="btn_scores">解析（scores直渡し）</button>
      </div>
    </div>

    <div class="card">
      <h3>Outputs</h3>
      <div class="grid">
        <span>DoQ</span><span class="out" id="out_doq">—</span><span></span>
        <span>CCI</span><span class="out" id="out_cci">—</span><span></span>
        <span>RDI</span><span class="out" id="out_rdi">—</span><span></span>
        <span>HRI</span><span class="out" id="out_hri">—</span><span></span>
        <span>TRS</span><span class="out" id="out_trs">—</span><span></span>
        <span>RVI</span><span class="out" id="out_rvi">—</span><span></span>
        <span>AHI</span><span class="out" id="out_ahi">—</span><span></span>
        <span>SCI</span><span class="out" id="out_sci">—</span><span id="out_grade" class="mono muted"></span>
      </div>
    </div>
  </div>

  <!-- JSONブリッジ（サーバはCloudflare、これはGitHubの index.html 置換） -->
  <script>
  (function(){
    const qs = (k)=> new URLSearchParams(location.search).get(k);
    const API = (qs('api') || 'https://icy-wave-e70d.hanabokur0.workers.dev').replace(/\/+$/,'');
    document.getElementById('api_url').textContent = API;

    // 値表示の同期
    for(const id of ['doq_q','doq_s','doq_d','doq_i','trs_f','trs_r','trs_w','trs_m']){
      const el = document.getElementById(id), v = document.getElementById(id+'_v');
      if(el && v){ el.addEventListener('input',()=> v.textContent = el.value); v.textContent = el.value; }
    }

    async function postJSON(path, payload){
      const res = await fetch(API + path, {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify(payload||{}),
        mode:'cors'
      });
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

    function buildFeatures(){
      const g = id => Number(document.getElementById(id)?.value ?? 0);
      return {
        DoQ:{questionCount:g('doq_q'), struct:g('doq_s'), diversity:g('doq_d'), integration:g('doq_i')},
        TRS:{fatigue:g('trs_f'), recovery:g('trs_r'), reward:g('trs_w'), meaning:g('trs_m')}
      };
    }

    function setOut(o){
      const put = (id,val)=>{ const el=document.getElementById(id); if(!el) return;
        if('value' in el) el.value=val; el.textContent=String(val); };
      if(!o) return;
      put('out_doq', o.DoQ); put('out_cci', o.CCI); put('out_rdi', o.RDI);
      put('out_hri', o.HRI); put('out_trs', o.TRS); put('out_rvi', o.RVI);
      put('out_ahi', o.AHI); put('out_sci', o.SCI);
      const g = document.getElementById('out_grade'); if(g) g.textContent = o.SCI_grade||'';
    }

    async function analyzeFeatures(){
      const out = await postJSON('/api/score', { inputs: buildFeatures() });
      setOut(out.outputs);
      console.log('[LoPAS] features→scores', out);
    }

    // scores直渡しは Part 2 で実装
    document.getElementById('btn_features')?.addEventListener('click', analyzeFeatures);
    document.getElementById('btn_scores')?.addEventListener('click', ()=>alert('Part 2 で有効化します'));
    window.__LOPAS_API__ = { analyzeFeatures }; // デバッグ用
  })();
  </script>
</body>
</html>

