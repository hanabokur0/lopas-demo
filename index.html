<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LoPAS Lifestyle Demo</title>
  <style>
    :root{--bg:#0b1020;--card:#121831;--muted:#9fb0d9;--text:#e9f0ff;--ok:#2fd47a;--warn:#ffb020;--bad:#ff5d6c}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif}
    body{margin:0;background:#0b1020;color:var(--text)}
    header{padding:20px;max-width:900px;margin:0 auto}
    h1{margin:0 0 6px;font-size:clamp(18px,3vw,26px)}
    .sub{color:var(--muted);font-size:14px}
    main{max-width:900px;margin:0 auto;padding:20px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:16px}
    .row{display:grid;grid-template-columns:140px 1fr 60px;gap:12px;align-items:center;margin:10px 0}
    input[type=number],input[type=range]{width:100%}
    button{background:#1f2b54;border:1px solid rgba(255,255,255,.2);color:#d9e6ff;padding:10px 14px;border-radius:12px;cursor:pointer}
    button:hover{filter:brightness(1.1)}
    .badge{display:inline-block;border-radius:999px;padding:4px 10px;font-weight:700;font-size:12px;margin:2px}
    .g{background:rgba(47,212,122,.15);color:#bdf3d6}
    .a{background:rgba(255,176,32,.15);color:#ffe3b3}
    .r{background:rgba(255,93,108,.15);color:#ffd0d4}
    .mono{font-family:ui-monospace,Consolas,monospace;font-size:12px;white-space:pre-wrap;color:#cae0ff}
  </style>
</head>
<body>
  <header>
    <h1>LoPAS Lifestyle Demo</h1>
    <div class="sub">Enter daily allocation + priorities → API → indices + advice</div>
  </header>

  <main>
    <!-- Inputs -->
    <section class="card">
      <h3>1. Daily Allocation (sum = 100)</h3>
      <div class="row"><label>Work</label><input id="q_work" type="number" min="0" max="100" value="25"/><span>%</span></div>
      <div class="row"><label>Rest</label><input id="q_rest" type="number" min="0" max="100" value="25"/><span>%</span></div>
      <div class="row"><label>Creative</label><input id="q_creative" type="number" min="0" max="100" value="25"/><span>%</span></div>
      <div class="row"><label>Social</label><input id="q_social" type="number" min="0" max="100" value="25"/><span>%</span></div>
    </section>

    <section class="card">
      <h3>2. Global Modulators (0–4)</h3>
      <div class="row"><label>Fast</label><input id="m_fast" type="number" min="0" max="4" value="2"/></div>
      <div class="row"><label>Low Cost</label><input id="m_cost" type="number" min="0" max="4" value="2"/></div>
      <div class="row"><label>Privacy</label><input id="m_priv" type="number" min="0" max="4" value="2"/></div>
    </section>

    <section class="card">
      <button id="submitBtn">Submit to API</button>
    </section>

    <!-- Outputs -->
    <section class="card">
      <h3>Outputs</h3>
      <div id="out_badges"></div>
      <div id="out_advice" style="margin-top:10px"></div>
      <pre id="out_json" class="mono"></pre>
    </section>
  </main>

  <script>
    const API = "https://icy-wave-e70d.hanabokur0.workers.dev";

    async function callAPI(payload){
      const res = await fetch(API+"/api/score",{
        method:"POST",
        headers:{"content-type":"application/json"},
        body:JSON.stringify(payload)
      });
      if(!res.ok) throw new Error("HTTP "+res.status);
      return await res.json();
    }

    function buildPayload(){
      const alloc = {
        work: Number(q_work.value||0),
        rest: Number(q_rest.value||0),
        creative: Number(q_creative.value||0),
        social: Number(q_social.value||0),
      };
      const mods = {
        fast: Number(m_fast.value||0),
        low_cost: Number(m_cost.value||0),
        privacy: Number(m_priv.value||0),
      };
      return {
        inputs: {
          documents: [
            { text: JSON.stringify({q0:alloc, M:mods}) }
          ]
        }
      };
    }

    function render(out){
      const b = document.getElementById("out_badges");
      b.innerHTML="";
      const bands = (v)=> v>=70?"r":v>=50?"a":"g";
      for(const k of ["DoQ","CCI","CRI","TRS","RVI"]){
        const val = out[k];
        if(val==null) continue;
        const span=document.createElement("span");
        span.className="badge "+bands(val);
        span.textContent=`${k}: ${val}`;
        b.appendChild(span);
      }
      const adv=document.getElementById("out_advice");
      adv.innerHTML="";
      if(out.judgment){
        adv.innerHTML = `<strong>${out.judgment.label}</strong><br>`+
          (out.judgment.bullets||[]).map(x=>"• "+x).join("<br>");
      }
      document.getElementById("out_json").textContent = JSON.stringify(out,null,2);
    }

    document.getElementById("submitBtn").addEventListener("click",async()=>{
      try{
        const payload=buildPayload();
        const res=await callAPI(payload);
        render(res.outputs||{});
      }catch(e){
        alert("Error: "+e.message);
      }
    });
  </script>
  <script>
  // ==== API ====
  const API = "https://icy-wave-e70d.hanabokur0.workers.dev";

  async function postJSON(path, payload){
    const res = await fetch(API+path,{
      method:"POST",
      headers:{ "content-type":"application/json" },
      body: JSON.stringify(payload),
      mode:"cors"
    });
    if(!res.ok) throw new Error("HTTP "+res.status);
    return await res.json();
  }

  // ==== Lifestyle 計算（クライアント側で軸→scoresにする） ====
  function normalize(v){ const s=Object.values(v).reduce((a,b)=>a+b,0)||1; const o={}; for(const k in v)o[k]=(v[k]||0)/s; return o; }

  function computeFromForm(){
    // STEP1: 配分
    const q0 = {
      work:     Number(document.getElementById("q_work").value||0),
      rest:     Number(document.getElementById("q_rest").value||0),
      creative: Number(document.getElementById("q_creative").value||0),
      social:   Number(document.getElementById("q_social").value||0),
    };
    const wcat = normalize({ Work:q0.work, Rest:q0.rest, Creative:q0.creative, Social:q0.social });

    // STEP3: モジュレータ（使わないが将来のバイアス用に保持）
    const M = {
      fast:     Number(document.getElementById("m_fast").value||0),
      low_cost: Number(document.getElementById("m_cost").value||0),
      privacy:  Number(document.getElementById("m_priv").value||0),
    };

    // Lifestyle 軸（テンプレ準拠・最小版）
    // TRS は rec/depth/dur を合成して1本に畳み込む（重みは暫定 0.4/0.3/0.3）
    const eps = 0.5;
    const ax = { DoQ:0, CCI:0, CRI:0, TRS_rec:0, TRS_depth:0, TRS_dur:0, RVI:0 };

    // 簡略マッピング（テンプレ2章の要旨を最小で反映）
    // Work     → DoQ, CCI, TRS_dur
    ax.DoQ      += wcat.Work * (2 + eps);
    ax.CCI      += wcat.Work * (2 + eps);
    ax.TRS_dur  += wcat.Work * (1 + eps);

    // Rest     → TRS_rec, TRS_depth, TRS_dur
    ax.TRS_rec  += wcat.Rest * (2 + eps);
    ax.TRS_depth+= wcat.Rest * (2 + eps);
    ax.TRS_dur  += wcat.Rest * (1 + eps);

    // Creative → DoQ, CCI, CRI, TRS_dur
    ax.DoQ      += wcat.Creative * (1 + eps);
    ax.CCI      += wcat.Creative * (1 + eps);
    ax.CRI      += wcat.Creative * (1 + eps);
    ax.TRS_dur  += wcat.Creative * (1 + eps);

    // Social   → CRI, CCI, RVI
    ax.CRI      += wcat.Social * (2 + eps);
    ax.CCI      += wcat.Social * (1 + eps);
    ax.RVI      += wcat.Social * (1 + eps);

    // 正規化して 0..1 に落とす
    const sum = Object.values(ax).reduce((a,b)=>a+b,0)||1;
    for(const k in ax) ax[k] = ax[k]/sum;

    // TRS 合成
    const TRS = 0.4*ax.TRS_rec + 0.3*ax.TRS_depth + 0.3*ax.TRS_dur;

    // Worker の Bモードへ渡す 0..100 scores
    const scores = {
      DoQ: Math.round(ax.DoQ*100),
      CCI: Math.round(ax.CCI*100),
      CRI: Math.round(ax.CRI*100),
      TRS: Math.round(TRS*100),
      RVI: Math.round(ax.RVI*100)
    };

    return { q0, M, scores };
  }

  // ==== 描画 ====
  function renderOutputs(o){
    const b = document.getElementById("out_badges");
    const adv = document.getElementById("out_advice");
    const raw = document.getElementById("out_json");
    b.innerHTML = ""; adv.innerHTML = ""; raw.textContent = "";

    const band = v => v>=70 ? 'r' : v>=50 ? 'a' : 'g';
    for(const k of ["DoQ","CCI","CRI","TRS","RVI","SCI"]){
      if(o[k]==null) continue;
      const span=document.createElement("span");
      span.className = "badge "+band(o[k]);
      span.textContent = `${k}: ${o[k]}`;
      b.appendChild(span);
    }
    if(o.judgment){
      adv.innerHTML = `<strong>${o.judgment.label}</strong><br>` +
        (o.judgment.bullets||[]).map(x=>"• "+x).join("<br>");
    }
    raw.textContent = JSON.stringify(o, null, 2);
  }

  // ==== 送信 ====
  document.getElementById("submitBtn").addEventListener("click", async ()=>{
    try{
      const {scores} = computeFromForm();
      // ★ ここが肝：documents ではなく scores を渡す（APIのBモード）
      const res = await postJSON("/api/score", { scores });
      renderOutputs(res.outputs || {});
    }catch(e){
      alert("Error: "+e.message);
    }
  });
</script>
</body>
</html>
